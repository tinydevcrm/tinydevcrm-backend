# AWS infrastructure setup

This document describes how to set up TinyDevCRM infrastructure on AWS.

## 1. `iam.yaml`: IAM user setup

1.  Make sure to have `awscli` and GNU make `make` installed on your local
    compute instance.

    Make sure to have a set of AWS root user credentials installed on your local
    compute instance via `aws configure`, and that specific `$AWS_PROFILE` is
    exported to the current shell environment.

2.  Copy over `iam-params.example.json` as `iam-params.json`, and configure all
    parameter values. The IAM user password must pass the default AWS password
    policy. The password can be changed after IAM user creation.

3.  Run:.

    ```bash
    make iam-create
    ```

4.  In the AWS console, take your root account ID, your newly created IAM user
    `tinydevcrm-user`, and your password `$MyIAMUserPassword`, and log into a
    session of AWS console.

5.  Open `Services | IAM`, and in `Users | tinydecrm-user | Security
    Credentials`, add an MFA device in `Assigned MFA Device`. Register an MFA
    device (I'm using Authy on Ubuntu), then log out and log back in as the same
    user. It should prompt you for an MFA code. Enter the code from your
    authenticator app and login.

6.  On the right-hand side of the top navbar, click on "Switch Role", just above
    "Sign Out. Switch role to role 'tinydevcrm-admin', using account ID
    'RootAWSAccountID' and role 'tinydevcrm-admin'.

    You should now have access to all AWS resources after switching to this
    role.

7.  Create a set of access credentials for this user. In `Services | IAM`, and
    in `Users | tinydevcrm-user | Security Credentials`, click on "Create Access
    Key". Then, create a new IAM user using command `aws configure --profile
    tinydevcrm-user`. This properly configures `~/.aws/credentials`.

    At this point, you need to configure `~/.aws/config`. Take the section:

    ```text
    [profile tinydevcrm-user]
    region = us-east-1
    output = json
    ```

    And turn it into this to properly configure MFA via CLI:

    ```text
    [profile tinydevcrm-user]
    source_profile = tinydevcrm-user
    role_arn = arn:aws:iam::${RootAWSAccountID}:role/tinydevcrm-admin
    role_session_name=tinydevcrm-user
    mfa_serial = arn:aws:iam::${RootAWSAccountID}:mfa/tinydevcrm-user
    region = us-east-1
    output = json
    ```

    Finally, export `AWS_PROFILE` as `tinydevcrm-user` to avoid piping
    `--profile` into `aws` commands:

    ```bash
    export AWS_PROFILE=tinydevcrm-user
    ```

    You should now be able to lift into admin role via MFA on the CLI. Check
    using command:

    ```bash
    aws s3 ls
    ```

    Or similar. It should prompt for MFA, then give the appropriate response
    without erroring out.

8.  To update, run:

    ```bash
    make iam-deploy
    ```

9.  To delete, run:

    ```bash
    make iam-terminate
    ```

## `vpc.yaml`: VPC and public subnet setup

1.  Deploy the VPC and subnets using `vpc.yaml`:

    ```bash
    make vpc-create
    ```

2.  To update, run:

    ```bash
    make vpc-deploy
    ```

3.  To delete, run:

    ```bash
    make vpc-terminate
    ```

## `persist.yaml`: AWS data layer

This creates an AWS Elastic Block Store (EBS) volume for the PostgreSQL
database, and an AWS Elastic File Store (EFS) volume for the static files
generated by the Django application.

1.  Create the data layer using `persist.yaml`:

    ```bash
    make persist-create
    ```

2.  To update, run:

    ```bash
    make persist-deploy
    ```

3.  To delete, run:

    ```bash
    make persist-terminate
    ```

## `ecr.yaml`: AWS Elastic Container Registry (ECR)

This creates a Docker registry on AWS where AWS Elastic Container Service can
pull Docker images from.

1.  Create the registry using `ecr.yaml`:

    ```bash
    make ecr-create
    ```

2.  To update, run:

    ```bash
    make ecr-deploy
    ```

3.  To delete, run:

    ```bash
    make ecr-terminate
    ```

## `db.yaml`: Compute layer for the PostgreSQL database

This creates a custom deployed database compute layer.

1.  Copy over `db-params.example.json` as `db-params.json`, and configure all
    parameter values.

2.  Create the registry using `db.yaml`:

    ```bash
    make db-create
    ```

3.  To update, run:

    ```bash
    make db-deploy
    ```

4.  To delete, run:

    ```bash
    make db-terminate
    ```

## `app.yaml`: Compute layer for the Django API layer

This creates a custom deployed Django compute layer for the API.

1.  Copy over `app-params.example.json` as `app-params.json`, and configure all
    parameter values.

2.  Create the registry using `app.yaml`:

    ```bash
    make app-create
    ```

3.  To update, run:

    ```bash
    make app-deploy
    ```

4.  To delete, run:

    ```bash
    make app-terminate
    ```
